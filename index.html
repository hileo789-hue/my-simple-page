<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案管理甘特圖 V3 (穩定修正版)</title>
    <style>
        /* --- 基礎設定 --- */
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; margin: 20px; background-color: #f5f7fa; color: #333; }
        h2 { margin-bottom: 10px; color: #2c3e50; }
        button { cursor: pointer; font-family: inherit; }
        select, input { font-family: inherit; }
        * { box-sizing: border-box; }

        /* --- 控制面板 --- */
        .controls-bar {
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            background: #fff; padding: 15px; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px;
            position: relative; z-index: 50; 
        }
        .btn-primary { background-color: #3498db; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        
        /* 視圖切換 */
        .view-switcher { display: flex; background: #e0e0e0; border-radius: 4px; padding: 2px; margin-right: 10px; }
        .view-btn { border: none; background: transparent; padding: 6px 12px; font-size: 13px; border-radius: 3px; color: #555; }
        .view-btn.active { background: #fff; color: #2c3e50; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* 下拉選單樣式 */
        .custom-dropdown-wrapper { display: flex; flex-direction: column; gap: 2px; }
        .custom-dropdown { position: relative; display: inline-block; min-width: 130px; }
        .dropdown-btn { width: 100%; padding: 6px 10px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 100%; width: max-content; max-width: 250px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 1px solid #ddd; border-radius: 4px; z-index: 100; margin-top: 2px; padding: 5px 0; }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 6px 10px; font-size: 13px; cursor: pointer; display: flex; align-items: center; }
        .filter-label { font-size: 11px; font-weight: bold; color: #555; }

        /* --- Modal (設定視窗) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: flex-start; padding-top: 50px; }
        .modal-content { background: #fff; width: 750px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .modal-body { padding: 0; overflow-y: auto; flex: 1; background: #fafafa; display: flex; flex-direction: column;}
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #fff; border-radius: 0 0 8px 8px; }
        .section-title { padding: 10px 20px; background: #eef2f7; color: #2c3e50; font-weight: bold; font-size: 14px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
        .section-title:first-child { border-top: none; }
        .cap-table { width: 100%; border-collapse: collapse; background: #fff; }
        .cap-table th { background: #f8f9fa; padding: 8px 15px; text-align: left; font-size: 13px; font-weight: bold; color: #555; border-bottom: 1px solid #ddd; }
        .cap-table td { padding: 8px 15px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        .cap-input { padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; width: 100%; box-sizing: border-box; }
        .cap-select { padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; width: 100%; }
        .btn-add-row { background: #2ecc71; color: #fff; border: none; width: 24px; height: 24px; border-radius: 4px; font-size: 16px; line-height: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-del-row { color: #e74c3c; background: none; border: none; font-size: 13px; text-decoration: underline; cursor: pointer; }

        /* --- 甘特圖主結構 --- */
        .gantt-wrapper {
            display: flex; border: 1px solid #dcdcdc; background: #fff;
            height: 70vh; overflow: hidden; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-radius: 4px;
        }

        /* 左側面板 */
        .panel-left {
            flex: 0 0 380px; display: flex; flex-direction: column;
            border-right: 1px solid #e0e0e0; z-index: 20; background: #fff;
        }
        /* 右側面板 */
        .panel-right {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; background: #fff;
        }

        /* Header */
        .gantt-header-container { flex: 0 0 50px; background-color: #f8f9fa; border-bottom: 1px solid #ccc; overflow: hidden; }
        
        /* Body 捲動區 */
        .gantt-body-container { flex: 1; overflow: hidden; position: relative; background-color: #fff; }
        #chartBody { overflow: auto; }

        .left-header-content { display: flex; height: 100%; align-items: center; font-weight: bold; color: #555; }
        .timeline-header { display: flex; height: 100%; align-items: center; min-width: max-content; }
        
        /* --- 關鍵修正：列樣式 --- */
        .gantt-row {
            display: flex;
            height: 36px; /* 強制高度 */
            min-height: 36px;
            max-height: 36px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            box-sizing: border-box;
            width: 100%;
            position: relative; /* 關鍵：絕對定位的參考點 */
            flex-shrink: 0; /* 關鍵：防止被壓縮 */
        }
        .row-hover { background-color: #f0f8ff !important; }

        .cell-name { flex: 1; padding-right: 10px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; cursor: pointer; user-select: none; }
        .cell-owner { width: 70px; text-align: center; font-size: 12px; border-left: 1px solid #eee; color: #666; flex-shrink: 0; height: 100%; display: flex; align-items: center; justify-content: center;}
        .toggle-btn { width: 20px; text-align: center; margin-right: 5px; color: #777; font-family: monospace;}
        
        .row-group-1 { background-color: #eef2f7; font-weight: bold; color: #2c3e50; }
        .row-group-2 { background-color: #fdfdfd; font-weight: 600; color: #555; }

        .time-cell { flex-shrink: 0; border-right: 1px solid #e8e8e8; font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; height: 100%; box-sizing: border-box; }
        .weekend { background-color: #fff0f0; color: #d00; }
        
        /* --- 關鍵修正：Bar 容器 --- */
        .bars-container { 
            position: relative; 
            min-width: max-content; 
            display: flex; /* 加入 Flex */
            flex-direction: column; /* 強制垂直排列 */
        }
        
        .timeline-bg { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 0; pointer-events: none; }
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ff4757; z-index: 25; pointer-events: none; }

        /* 條狀圖：相對於 gantt-row 定位 */
        .gantt-bar { position: absolute; height: 18px; top: 9px; border-radius: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 10; font-size: 10px; color: rgba(255,255,255,0.95); overflow: hidden; white-space: nowrap; display: flex; align-items: center; padding-left: 5px; }
        .summary-bar { position: absolute; height: 12px; top: 12px; background-color: #666; border-radius: 6px; z-index: 10; cursor: help; }
        .summary-bar::before, .summary-bar::after { content: ''; position: absolute; top: 100%; border: 4px solid transparent; border-top-color: #666; }
        .summary-bar::before { left: 0; } .summary-bar::after { right: 0; }

        .diff-低 { background-color: #2ecc71; }
        .diff-中 { background-color: #3498db; }
        .diff-高 { background-color: #e74c3c; }

        #customTooltip { position: fixed; display: none; background: #fff; border: 1px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; z-index: 3000; font-size: 12px; color: #333; max-width: 300px; pointer-events: none; }
        .loading { padding: 20px; color: #555; font-weight: bold; }
    </style>
</head>
<body>

    <h2>專案管理甘特圖 V3</h2>
    
    <div class="controls-bar">
        <button class="btn-primary" onclick="openCapacityModal()" style="margin-right: 10px;">⚙️ 人員產能設定</button>
        <button class="btn-danger" onclick="clearConfig()">↻ 重置設定</button>

        <div style="font-weight:bold; font-size:13px; margin-left:20px; margin-right:5px;">視圖:</div>
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('Day')">日</button>
            <button class="view-btn" onclick="switchView('Week')">週</button>
            <button class="view-btn" onclick="switchView('Month')">月</button>
        </div>

        <div style="display:flex; gap:10px; margin-left: 15px;">
            <div class="custom-dropdown-wrapper">
                <span class="filter-label">人員</span>
                <div class="custom-dropdown" id="dd-owner"><button class="dropdown-btn">全部選取</button><div class="dropdown-content"></div></div>
            </div>
            <div class="custom-dropdown-wrapper">
                <span class="filter-label">分類1</span>
                <div class="custom-dropdown" id="dd-cat1"><button class="dropdown-btn">全部選取</button><div class="dropdown-content"></div></div>
            </div>
        </div>

        <div style="margin-left:auto; display:flex; align-items:center; font-size:12px;">
            <div class="legend-color diff-低" style="width:12px;height:12px;border-radius:2px;margin-right:3px;"></div>低
            <div class="legend-color diff-中" style="width:12px;height:12px;border-radius:2px;margin-right:3px;margin-left:10px;"></div>中
            <div class="legend-color diff-高" style="width:12px;height:12px;border-radius:2px;margin-right:3px;margin-left:10px;"></div>高
            <span style="margin-left:10px; color:#ff4757; font-weight:bold;">| 今日</span>
        </div>
    </div>

    <div id="loading" class="loading">正在讀取並計算排程...</div>

    <div class="gantt-wrapper" id="ganttApp" style="display:none;">
        <div class="panel-left">
            <div class="gantt-header-container">
                <div class="left-header-content">
                    <div class="cell-name" style="justify-content:center; padding-left:20px;">任務 WBS</div>
                    <div class="cell-owner">負責人</div>
                </div>
            </div>
            <div class="gantt-body-container" id="leftBody">
                <div id="taskListContent"></div>
            </div>
        </div>

        <div class="panel-right">
            <div class="gantt-header-container" id="rightHeader">
                <div class="timeline-header" id="timelineHeader"></div>
            </div>
            <div class="gantt-body-container" id="chartBody">
                <div class="bars-container" id="barsContainer">
                    <div class="timeline-bg" id="timelineBg"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="capacityModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">人員產能設定</div>
                <button onclick="closeCapacityModal()" style="background:none; border:none; font-size:18px;">✕</button>
            </div>
            <div class="modal-body">
                <div class="section-title">1. 基本設定 (開工日)</div>
                <div style="padding:0;"><table class="cap-table"><thead><tr><th style="width:200px;">人員姓名</th><th>專案開工日期</th></tr></thead><tbody id="basicSettingBody"></tbody></table></div>
                <div class="section-title" style="margin-top:10px;">2. 產能例外 (請假/支援)</div>
                <div style="flex:1; overflow-y:auto;"><table class="cap-table"><thead><tr><th style="width:40px;"><button class="btn-add-row" onclick="addCapacityRow()">+</button></th><th style="width:150px;">人員</th><th style="width:140px;">起日</th><th style="width:140px;">迄日</th><th style="width:90px;">投入 %</th><th></th></tr></thead><tbody id="capacityTableBody"></tbody></table></div>
            </div>
            <div class="modal-footer"><button class="btn-primary" onclick="saveCapacitySettings()">儲存並計算</button></div>
        </div>
    </div>
    <div id="customTooltip"></div>

<script>
    // 使用你原本提供的 Google Sheet 連結
    const SHEET_TASKS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMt2b5Lb70ThslYptMoDFsgcB5lTTo7GwPnx18MuZ1xo5vZUqK1705TfFM6vhC-ZHJc6JbIaLgJz01/pub?gid=1959210146&single=true&output=csv";

    // --- 全域變數 ---
    let VIEW_MODE = 'Day';
    const PIXELS_PER_DAY = { 'Day': 30, 'Week': 7, 'Month': 2 };

    let RAW_TASKS_DATA = []; 
    let CALCULATED_TASKS = []; 
    let ALL_OWNERS = []; 
    
    let GLOBAL_START = null;
    let GLOBAL_END = null;
    const COLLAPSED_STATE = new Set();
    const SELECTED_FILTERS = { owner: new Set(), cat1: new Set() };

    // Config Storage
    let GANTT_CONFIG = JSON.parse(localStorage.getItem('gantt_config_v2')) || { startDates: {}, exceptions: {} };

    async function init() {
        try {
            const tasksData = await fetchData(SHEET_TASKS_URL);
            RAW_TASKS_DATA = tasksData; 
            
            const ownersSet = new Set();
            RAW_TASKS_DATA.forEach(t => { if(t['人員姓名']) ownersSet.add(t['人員姓名']); });
            ALL_OWNERS = Array.from(ownersSet).sort();

            const todayStr = new Date().toISOString().split('T')[0];
            let configChanged = false;
            ALL_OWNERS.forEach(owner => {
                if (!GANTT_CONFIG.startDates[owner]) {
                    GANTT_CONFIG.startDates[owner] = todayStr;
                    configChanged = true;
                }
            });
            if(configChanged) localStorage.setItem('gantt_config_v2', JSON.stringify(GANTT_CONFIG));

            initFilters(RAW_TASKS_DATA);
            recalculateSchedule();
        } catch (e) {
            document.getElementById('loading').innerText = "讀取失敗: " + e.message;
            console.error(e);
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show'));
            }
        });
    }

    async function fetchData(url) {
        // 加入時間戳記防止快取
        const resp = await fetch(url + "&t=" + new Date().getTime());
        return parseCSV(await resp.text());
    }

    function parseCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim());
        const result = [];
        for (let i = 1; i < lines.length; i++) {
            // 處理CSV可能的空行或不完整
            if(!lines[i].trim()) continue;
            let row = lines[i].split(','); 
            const obj = {};
            headers.forEach((h, idx) => obj[h] = row[idx] ? row[idx].trim() : "");
            // 確保有資料才加入
            if(obj['任務名稱']) result.push(obj);
        }
        return result;
    }

    // --- 排程計算 ---
    function getCapacityRate(owner, dateObj) {
        const exceptions = GANTT_CONFIG.exceptions[owner];
        if (!exceptions || exceptions.length === 0) return 1.0;
        const time = dateObj.getTime();
        for (let s of exceptions) {
            const sTime = new Date(s.start).getTime();
            const eTime = new Date(s.end).getTime();
            if (time >= sTime && time <= eTime) {
                return parseFloat(s.rate) || 0;
            }
        }
        return 1.0;
    }

    function getPersonStartDate(owner) {
        const s = GANTT_CONFIG.startDates[owner];
        return s ? new Date(s) : new Date();
    }

    function calculateTaskEndDate(startDate, manDays, owner) {
        let workRemaining = parseFloat(manDays) || 1;
        let current = new Date(startDate);
        let safetyCounter = 0;
        const MAX_DAYS = 365 * 5; 
        while (workRemaining > 0 && safetyCounter < MAX_DAYS) {
            const day = current.getDay();
            if (day !== 0 && day !== 6) {
                const rate = getCapacityRate(owner, current);
                if (rate > 0) workRemaining -= rate;
            }
            if (workRemaining > 0) current.setDate(current.getDate() + 1);
            safetyCounter++;
        }
        while (current.getDay() === 0 || current.getDay() === 6) current.setDate(current.getDate() + 1);
        return current;
    }

    function getNextWorkDay(date) {
        let next = new Date(date);
        next.setDate(next.getDate() + 1);
        while (next.getDay() === 0 || next.getDay() === 6) next.setDate(next.getDate() + 1);
        return next;
    }

    function recalculateSchedule() {
        const personTasks = {};
        RAW_TASKS_DATA.forEach(t => {
            const owner = t['人員姓名'];
            if (!owner) return;
            if (!personTasks[owner]) personTasks[owner] = [];
            personTasks[owner].push(t);
        });

        let calculated = [];
        let minDate = new Date("2030-01-01");
        let maxDate = new Date("2020-01-01");
        let hasAnyData = false;

        for (let owner in personTasks) {
            let tracker = getPersonStartDate(owner);
            while (tracker.getDay() === 0 || tracker.getDay() === 6) tracker.setDate(tracker.getDate() + 1);
            
            // 修正排序：使用新的 '個人執行順序'
            const myTasks = personTasks[owner].sort((a, b) => parseInt(a['個人執行順序']) - parseInt(b['個人執行順序']));
            
            myTasks.forEach(task => {
                const manDays = parseFloat(task['標準人天']) || 1;
                const start = new Date(tracker);
                const end = calculateTaskEndDate(start, manDays, owner);
                
                // 防呆：如果日期計算出錯 (NaN)，強制給當天
                if (isNaN(start.getTime())) start = new Date();
                if (isNaN(end.getTime())) end = new Date();

                const taskObj = { ...task, _start: start, _end: end, _duration: manDays };
                calculated.push(taskObj);
                
                if (start < minDate) minDate = new Date(start);
                if (end > maxDate) maxDate = new Date(end);
                hasAnyData = true;
                tracker = getNextWorkDay(end);
            });
        }

        if (!hasAnyData) { GLOBAL_START = new Date(); GLOBAL_END = new Date(); } 
        else { GLOBAL_START = minDate; GLOBAL_END = maxDate; }
        
        // 修正排序：使用新的 '任務執行順序'
        calculated.sort((a, b) => parseInt(a['任務執行順序']) - parseInt(b['任務執行順序']));
        CALCULATED_TASKS = calculated;
        applyFiltersAndRender();
    }

    // --- UI & 渲染 ---
    function initFilters(tasks) {
        const sets = { cat1: new Set() };
        tasks.forEach(t => {
            if(t['任務分類1']) sets.cat1.add(t['任務分類1']);
        });
        initCustomDropdown('dd-owner', new Set(ALL_OWNERS), 'owner');
        initCustomDropdown('dd-cat1', sets.cat1, 'cat1');
    }

    function initCustomDropdown(elementId, dataSet, filterKey) {
        const wrapper = document.getElementById(elementId);
        const btn = wrapper.querySelector('.dropdown-btn');
        const content = wrapper.querySelector('.dropdown-content');
        SELECTED_FILTERS[filterKey] = new Set(dataSet); 
        const sorted = Array.from(dataSet).sort();
        content.innerHTML = '';
        const allDiv = document.createElement('div'); allDiv.className = 'dropdown-item'; allDiv.innerHTML = `<label style="cursor:pointer; width:100%"><input type="checkbox" checked value="ALL"> (全選)</label>`; content.appendChild(allDiv);
        sorted.forEach(val => { const div = document.createElement('div'); div.className = 'dropdown-item'; div.innerHTML = `<label style="cursor:pointer; width:100%"><input type="checkbox" checked value="${val}"> ${val}</label>`; content.appendChild(div); });
        btn.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.dropdown-content').forEach(el => { if(el !== content) el.classList.remove('show'); }); content.classList.toggle('show'); });
        content.addEventListener('change', (e) => {
            const target = e.target; const inputs = content.querySelectorAll('input[type="checkbox"]:not([value="ALL"])'); const allCheck = content.querySelector('input[value="ALL"]');
            if (target.value === 'ALL') { inputs.forEach(inp => inp.checked = target.checked); } else { allCheck.checked = Array.from(inputs).every(i => i.checked); }
            SELECTED_FILTERS[filterKey].clear(); inputs.forEach(inp => { if (inp.checked) SELECTED_FILTERS[filterKey].add(inp.value); });
            const count = SELECTED_FILTERS[filterKey].size; btn.innerText = (count === sorted.length) ? '全部選取' : `已選 ${count} 項`;
            applyFiltersAndRender();
        });
    }

    function switchView(mode) {
        VIEW_MODE = mode; document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === (mode==='Day'?'日':mode==='Week'?'週':'月')));
        applyFiltersAndRender();
    }

    function applyFiltersAndRender() {
        const taskListEl = document.getElementById('taskListContent');
        const barsContainerEl = document.getElementById('barsContainer');
        const headerEl = document.getElementById('timelineHeader');
        const bgEl = document.getElementById('timelineBg');
        
        const filtered = CALCULATED_TASKS.filter(t => {
            if (!SELECTED_FILTERS.owner.has(t['人員姓名'])) return false;
            if (!SELECTED_FILTERS.cat1.has(t['任務分類1'])) return false;
            return true;
        });

        const tree = [];
        filtered.forEach(task => {
            const c1Name = task['任務分類1'] || '未分類'; const c2Name = task['任務分類2'] || '未分類';
            let cat1Node = tree.find(n => n.name === c1Name); if (!cat1Node) { cat1Node = { type: 'cat1', name: c1Name, children: [], id: `Cat1:${c1Name}`, _start: new Date("2099-12-31"), _end: new Date("1900-01-01") }; tree.push(cat1Node); }
            let cat2Node = cat1Node.children.find(n => n.name === c2Name); if (!cat2Node) { cat2Node = { type: 'cat2', name: c2Name, children: [], id: `Cat2:${c1Name}>${c2Name}`, _start: new Date("2099-12-31"), _end: new Date("1900-01-01") }; cat1Node.children.push(cat2Node); }
            cat2Node.children.push(task);
            const updateTime = (p, c) => { if (c._start < p._start) p._start = c._start; if (c._end > p._end) p._end = c._end; };
            updateTime(cat2Node, task); updateTime(cat1Node, task);
        });

        // Clear
        taskListEl.innerHTML = ''; headerEl.innerHTML = ''; barsContainerEl.innerHTML = ''; 
        barsContainerEl.appendChild(bgEl); // Re-add bg

        const pxPerDay = PIXELS_PER_DAY[VIEW_MODE];
        let renderStart = new Date(GLOBAL_START); renderStart.setDate(renderStart.getDate() - 7);
        if (VIEW_MODE === 'Week') renderStart.setDate(renderStart.getDate() - renderStart.getDay());
        if (VIEW_MODE === 'Month') renderStart.setDate(1);
        const totalMs = GLOBAL_END - renderStart;
        const totalDays = Math.ceil(totalMs / (1000 * 60 * 60 * 24)) + 40; 
        const totalWidth = totalDays * pxPerDay;
        barsContainerEl.style.width = `${totalWidth}px`; bgEl.style.width = `${totalWidth}px`;

        // Render Header
        if (VIEW_MODE === 'Day') {
            bgEl.style.backgroundSize = `${pxPerDay}px 100%`; bgEl.style.backgroundImage = `linear-gradient(90deg, transparent ${pxPerDay-1}px, #eee ${pxPerDay}px)`;
            let curr = new Date(renderStart);
            for (let i = 0; i < totalDays; i++) {
                const dDiv = document.createElement('div'); dDiv.className = 'time-cell'; dDiv.style.width = `${pxPerDay}px`;
                dDiv.innerHTML = `<span>${curr.getDate()}</span><span style="font-size:9px">${curr.getMonth()+1}月</span>`;
                if (curr.getDay()===0||curr.getDay()===6) dDiv.classList.add('weekend');
                headerEl.appendChild(dDiv); curr.setDate(curr.getDate() + 1);
            }
        } else if (VIEW_MODE === 'Week') {
            const weekWidth = pxPerDay * 7;
            bgEl.style.backgroundSize = `${weekWidth}px 100%`; bgEl.style.backgroundImage = `linear-gradient(90deg, transparent ${weekWidth-1}px, #ddd ${weekWidth}px)`;
            let curr = new Date(renderStart);
            for (let i = 0; i < Math.ceil(totalDays/7); i++) {
                const dDiv = document.createElement('div'); dDiv.className = 'time-cell'; dDiv.style.width = `${weekWidth}px`;
                const d = new Date(Date.UTC(curr.getFullYear(), curr.getMonth(), curr.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                const weekNo = Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1)/7);
                dDiv.innerHTML = `<span>W${weekNo}</span><span style="font-size:9px">${curr.getMonth()+1}/${curr.getDate()}</span>`;
                headerEl.appendChild(dDiv); curr.setDate(curr.getDate() + 7);
            }
        } else if (VIEW_MODE === 'Month') {
            bgEl.style.backgroundImage = 'none';
            let curr = new Date(renderStart); let pxAccum = 0;
            while (pxAccum < totalWidth) {
                const w = new Date(curr.getFullYear(), curr.getMonth() + 1, 0).getDate() * pxPerDay;
                const dDiv = document.createElement('div'); dDiv.className = 'time-cell'; dDiv.style.width = `${w}px`; dDiv.style.borderRight = '1px solid #ccc';
                dDiv.innerHTML = `<span style="font-weight:bold">${curr.getMonth()+1}月</span><span style="font-size:9px">${curr.getFullYear()}</span>`;
                headerEl.appendChild(dDiv);
                const line = document.createElement('div'); line.style.position='absolute'; line.style.left=`${pxAccum+w}px`; line.style.top='0'; line.style.height='100%'; line.style.borderRight='1px solid #eee'; bgEl.appendChild(line);
                pxAccum += w; curr.setMonth(curr.getMonth() + 1);
            }
        }

        const today = new Date(); const todayDiff = (today - renderStart) / (1000*60*60*24);
        if (todayDiff >= 0) { const line = document.createElement('div'); line.className = 'today-line'; line.style.left = `${todayDiff * pxPerDay}px`; barsContainerEl.appendChild(line); }

        let visibleNodes = [];
        function flattenTree(nodes) {
            nodes.forEach(node => {
                visibleNodes.push(node);
                if (node.type && !COLLAPSED_STATE.has(node.id)) {
                    flattenTree(node.children);
                }
            });
        }
        flattenTree(tree);

        const totalRowHeight = visibleNodes.length * 36; 
        barsContainerEl.style.height = `${Math.max(totalRowHeight, 500)}px`; 
        bgEl.style.height = '100%';

        visibleNodes.forEach((node, rowIndex) => {
            const leftRow = document.createElement('div');
            leftRow.className = `gantt-row ${node.type==='cat1'?'row-group-1':node.type==='cat2'?'row-group-2':''}`;
            let indent = node.type === 'cat1' ? 10 : node.type === 'cat2' ? 30 : 50;
            if (node.type) {
                const icon = COLLAPSED_STATE.has(node.id) ? '▶' : '▼';
                leftRow.innerHTML = `<div class="cell-name" style="padding-left:${indent}px" onclick="toggleGroup('${node.id}')"><span class="toggle-btn">${icon}</span> ${node.name} <span style="font-size:11px; color:#888; margin-left:5px;">(${node.children.length})</span></div>`;
            } else {
                leftRow.innerHTML = `<div class="cell-name" style="padding-left:${indent}px">${node['任務名稱']}</div><div class="cell-owner">${node['人員姓名']}</div>`;
            }
            taskListEl.appendChild(leftRow);

            const rightRow = document.createElement('div'); 
            rightRow.className = 'gantt-row'; 
            rightRow.style.width = `${totalWidth}px`;

            const barLeft = ((node._start - renderStart) / 86400000) * pxPerDay;
            const barWidth = Math.max(((node._end - node._start) / 86400000 + 1) * pxPerDay, 2);

            if (node.type) {
                const bar = document.createElement('div'); bar.className = 'summary-bar'; bar.style.left = `${barLeft}px`; bar.style.width = `${barWidth}px`;
                bar.addEventListener('mousemove', (e)=>showTooltip(e, node)); bar.addEventListener('mouseleave', hideTooltip); 
                rightRow.appendChild(bar);
            } else {
                const bar = document.createElement('div'); bar.className = `gantt-bar diff-${node['難易度']}`; bar.style.left = `${barLeft}px`; bar.style.width = `${barWidth}px`;
                if (barWidth > 40 && VIEW_MODE !== 'Month') bar.innerText = `${node._start.getMonth()+1}/${node._start.getDate()}`;
                bar.title = `${node['任務名稱']}\n人員: ${node['人員姓名']}\n期間: ${node._start.toLocaleDateString()} - ${node._end.toLocaleDateString()}\n工期: ${node['標準人天']}天`;
                rightRow.appendChild(bar);
            }
            barsContainerEl.appendChild(rightRow);

            const syncHover = (add) => { const action = add?'add':'remove'; leftRow.classList[action]('row-hover'); rightRow.classList[action]('row-hover'); };
            leftRow.addEventListener('mouseenter', ()=>syncHover(true)); leftRow.addEventListener('mouseleave', ()=>syncHover(false));
            rightRow.addEventListener('mouseenter', ()=>syncHover(true)); rightRow.addEventListener('mouseleave', ()=>syncHover(false));
        });
        
        document.getElementById('loading').style.display = 'none'; document.getElementById('ganttApp').style.display = 'flex';
        
        const chartBody = document.getElementById('chartBody'); 
        const leftBody = document.getElementById('leftBody'); 
        const rightHeader = document.getElementById('rightHeader');
        chartBody.onscroll = () => {
            leftBody.scrollTop = chartBody.scrollTop;
            rightHeader.scrollLeft = chartBody.scrollLeft;
        };
    }

    function toggleGroup(id) {
        if (COLLAPSED_STATE.has(id)) COLLAPSED_STATE.delete(id); else COLLAPSED_STATE.add(id);
        applyFiltersAndRender();
    }

    const tooltipEl = document.getElementById('customTooltip');
    function showTooltip(e, node) {
        let allTasks = []; const collect = (n) => { if(n.type) n.children.forEach(collect); else allTasks.push(n); }; collect(node);
        allTasks.sort((a,b) => a._start - b._start);
        let html = `<h4>${node.name} (${allTasks.length})</h4><div style="margin-bottom:5px;font-size:11px;color:#555;">${node._start.toLocaleDateString()} ~ ${node._end.toLocaleDateString()}</div>`;
        const limit = 8;
        for (let i = 0; i < Math.min(allTasks.length, limit); i++) { html += `<div style="display:flex; justify-content:space-between; margin-bottom:3px;"><span style="color:#2c3e50; font-weight:600;">${allTasks[i]['任務名稱']}</span><span style="font-size:11px;">${allTasks[i]['人員姓名']}</span></div>`; }
        if (allTasks.length > limit) html += `<div style="text-align:center; color:#888; font-style:italic;">...還有 ${allTasks.length - limit} 筆</div>`;
        tooltipEl.innerHTML = html; tooltipEl.style.display = 'block';
        const x = e.pageX + 15; const y = e.pageY + 15;
        tooltipEl.style.left = (x + 300 > window.innerWidth ? e.pageX - 310 : x) + 'px';
        tooltipEl.style.top = (y + tooltipEl.offsetHeight > window.innerHeight ? e.pageY - tooltipEl.offsetHeight : y) + 'px';
    }
    function hideTooltip() { tooltipEl.style.display = 'none'; }

    // --- Modal ---
    let TEMP_BASIC = {}; let TEMP_EXCEPTIONS = []; 
    function openCapacityModal() {
        TEMP_BASIC = { ...GANTT_CONFIG.startDates };
        ALL_OWNERS.forEach(o => { if(!TEMP_BASIC[o]) TEMP_BASIC[o] = new Date().toISOString().split('T')[0]; });
        renderBasicSettingTable();
        TEMP_EXCEPTIONS = [];
        for (let owner in GANTT_CONFIG.exceptions) { GANTT_CONFIG.exceptions[owner].forEach(item => { TEMP_EXCEPTIONS.push({ owner: owner, ...item }); }); }
        renderCapacityTable();
        document.getElementById('capacityModal').style.display = 'flex';
    }
    function closeCapacityModal() { document.getElementById('capacityModal').style.display = 'none'; }
    function renderBasicSettingTable() {
        const tbody = document.getElementById('basicSettingBody'); tbody.innerHTML = '';
        ALL_OWNERS.forEach(owner => {
            const tr = document.createElement('tr'); tr.innerHTML = `<td>${owner}</td><td><input type="date" class="cap-input" value="${TEMP_BASIC[owner]}" onchange="updateBasic('${owner}', this.value)"></td>`; tbody.appendChild(tr);
        });
    }
    function updateBasic(owner, val) { TEMP_BASIC[owner] = val; }
    function renderCapacityTable() {
        const tbody = document.getElementById('capacityTableBody'); tbody.innerHTML = '';
        if (TEMP_EXCEPTIONS.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">目前無例外設定 (所有人皆為預設 100% 投入)</td></tr>'; return; }
        TEMP_EXCEPTIONS.forEach((item, index) => {
            const tr = document.createElement('tr');
            let ownerOptions = ALL_OWNERS.map(o => `<option value="${o}" ${o === item.owner ? 'selected' : ''}>${o}</option>`).join('');
            tr.innerHTML = `<td style="text-align:center; color:#ccc;">${index + 1}</td><td><select class="cap-select" onchange="updateExList(${index}, 'owner', this.value)">${ownerOptions}</select></td><td><input type="date" class="cap-input" value="${item.start}" onchange="updateExList(${index}, 'start', this.value)"></td><td><input type="date" class="cap-input" value="${item.end}" onchange="updateExList(${index}, 'end', this.value)"></td><td><input type="number" class="cap-input" value="${item.rate * 100}" min="0" max="200" onchange="updateExList(${index}, 'rate', this.value)"></td><td><button class="btn-del-row" onclick="removeExRow(${index})">刪除</button></td>`;
            tbody.appendChild(tr);
        });
    }
    function addCapacityRow() { const todayStr = new Date().toISOString().split('T')[0]; TEMP_EXCEPTIONS.unshift({ owner: ALL_OWNERS[0] || '', start: todayStr, end: todayStr, rate: 0.5 }); renderCapacityTable(); }
    function removeExRow(index) { TEMP_EXCEPTIONS.splice(index, 1); renderCapacityTable(); }
    function updateExList(index, field, value) { if (field === 'rate') TEMP_EXCEPTIONS[index][field] = parseFloat(value) / 100; else TEMP_EXCEPTIONS[index][field] = value; }
    function saveCapacitySettings() {
        GANTT_CONFIG.startDates = { ...TEMP_BASIC };
        const newEx = {}; TEMP_EXCEPTIONS.forEach(item => { if (!newEx[item.owner]) newEx[item.owner] = []; newEx[item.owner].push({ start: item.start, end: item.end, rate: item.rate }); });
        GANTT_CONFIG.exceptions = newEx;
        localStorage.setItem('gantt_config_v2', JSON.stringify(GANTT_CONFIG));
        recalculateSchedule(); closeCapacityModal(); alert('設定已儲存並更新排程！');
    }
    function clearConfig() {
        if(confirm("確定要清除所有人員開工日與產能設定嗎？")) {
            localStorage.removeItem('gantt_config_v2');
            location.reload();
        }
    }

    init();
</script>
</body>
</html>
